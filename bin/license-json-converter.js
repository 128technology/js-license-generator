#!/usr/bin/env node

const fs = require('fs');
const minimist = require('minimist');
const _ = require('lodash');
const chalk = require('chalk');
const semver = require('semver');
const { XLSXBuilder } = require('../lib/builders');

const argv = minimist(process.argv);

if (argv.help) {
  console.log('Usage:');
  console.log('license-json-converter [arguments]');
  console.log();
  console.log('Description:');
  console.log('Converts a json license file into another supported format.');
  console.log('Supported formats: CSV');
  console.log(
    'The json license file should be formatted like the ones that js-license-generator or license-parser makes.'
  );
  console.log();
  console.log('Arguments:');
  console.log('--name=<string>           The name of the output file (default is "output".)');
  console.log(
    '--cacheFile=<path>      An absolute path to a text based license file, typically one generated by the license generator.'
  );
  console.log('--help                   This help.');
  process.exit(0);
}

const { name, cacheFile } = argv;

const licenses = JSON.parse(fs.readFileSync(cacheFile, 'utf-8'));
const builder = new XLSXBuilder();

const outputName = name ? name : 'output';

_.forEach(licenses, (pkg, pkgName) => {
  const versionText = _.omit(pkg, ['repository', 'types']);
  const versions = _.keys(versionText);
  const version = _.reduce(versions, (result, value) => {
    if (semver.gt(result, value)) {
      return result;
    }
    return value;
  });
  const text = pkg[version];
  let types = pkg.types ? pkg.types : '';
  types = Array.isArray(types) ? types.join(',') : types;

  builder.addCached(pkgName, version, text, types);
});

builder.write(outputName);
console.log(chalk.green(`Wrote file: ${outputName}.csv`));
